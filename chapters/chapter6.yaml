---
# Chapter 6 automation playbook
# Be sure to reference the inventory file for your cluster.

- hosts: openshift-masters
  remote_user: centos
  become: yes
  vars:
    master_config_file: /etc/origin/master/master-config.yaml
    htpasswd_file: /etc/origin/master/openshift.htpasswd
    openshift_users:
    - developer
    - project-admin
    - admin

  tasks:
  - name: create users in htpasswd database
    htpasswd:
      path: "{{ htpasswd_file }}"
      name: "{{ item }}"
      password: "{{ item }}"
      owner: root
      group: root
      mode: 0640
    with_items: "{{ openshift_users }}"

  - name: add htpasswd provider name
    lineinfile:
      name: "{{ master_config_file }}"
      line: "    name: htpasswd_provider"
      regexp: 'name: allow_all'

  - name: edit provider type
    lineinfile:
      name: "{{ master_config_file }}"
      line: "      kind: HTPasswdPasswordIdentityProvider"
      regexp: 'AllowAllPasswordIdentityProvider'

  - name: add reference to htpasswd file
    lineinfile:
      name: "{{ master_config_file }}"
      line: "      file: {{ htpasswd_file }}"
      insertafter: "    kind: HTPasswdPasswordIdentityProvider"
